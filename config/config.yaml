# =============================================================================
# ARGUS - Main Configuration
# =============================================================================
# Named after Argus Panoptes, the all-seeing giant of Greek mythology
# who had 100 eyes and never slept - perfect for 24/7 market monitoring
# =============================================================================

system:
  name: "Argus"
  version: "2.0.0"
  timezone: "UTC"
  log_level: "INFO"  # DEBUG, INFO, WARNING, ERROR

# -----------------------------------------------------------------------------
# Logging (structured, rotating)
# -----------------------------------------------------------------------------
logging:
  console_level: "INFO"
  file_level: "DEBUG"
  log_dir: "data/logs"
  max_bytes: 52428800    # 50 MB per file
  backup_count: 10

# -----------------------------------------------------------------------------
# Data Source Policy
# -----------------------------------------------------------------------------
# Canonical provider selections for all Argus pipelines. Replay packs,
# experiment runners, and strategies read these defaults so you never
# need to specify --provider manually.
#
# PRIMARY SOURCES
#   bars_primary       — 1-min OHLCV bars.  Provider: alpaca
#   outcomes_from      — forward-return outcomes.  Derived from bars_primary
#                        (OutcomeEngine consumes bars from this source).
#   options_snapshots_primary — option chain quotes + strikes/expiries + IV
#                        surface fields.  Provider: tastytrade (REST).
#                        This is the authoritative IV source.
#   options_stream_primary   — real-time option quotes + greeks (DXLink).
#                        Provider: tastytrade_dxlink.
#
# SECONDARY SOURCES (redundancy / sanity-check only)
#   options_snapshots_secondary — secondary options provider for
#                        validation and fallback (the non-primary
#                        provider: tastytrade or public).
#   bars_secondary      — optional backfill / cross-validation.
#                        Provider: yahoo.
#
data_sources:
  bars_primary: "alpaca"
  outcomes_from: "bars_primary"            # always derived from bars_primary
  options_snapshots_primary: "tastytrade"  # authoritative IV / surface source
  options_snapshots_secondary: "public"                             # secondary options provider for validation/fallback
  options_stream_primary: "tastytrade_dxlink"
  bars_secondary: "yahoo"                              # optional sanity / backfill

# -----------------------------------------------------------------------------
# Assets to Monitor
# -----------------------------------------------------------------------------
assets:
  perpetuals:
    - "BTC/USDT:USDT"
    - "ETH/USDT:USDT"
    - "SOL/USDT:USDT"

  # Dynamic discovery: track these base assets on Bybit linear perpetuals.
  # The discover CLI resolves actual symbols from the exchange.
  bybit_base_coins: ["BTC", "ETH", "SOL", "DOGE", "ARB"]

  options:
    - "BTC"  # Deribit BTC options

# -----------------------------------------------------------------------------
# Exchange Configuration
# -----------------------------------------------------------------------------
exchanges:
  bybit:
    enabled: true
    testnet: false
    rate_limit: 10  # requests per second
    reconnect_delay: 5  # initial delay, will use exponential backoff
    max_reconnect_delay: 300  # max 5 minutes between reconnects

    # REST backfill settings
    backfill:
      enabled: true
      rate_limit_rps: 8           # conservative REST rate limit
      max_bars_per_run: 50000     # safety cap per CLI invocation
      chunk_size: 200             # Bybit kline API max per request

  deribit:
    enabled: true
    testnet: true  # Start with testnet for safety
    rate_limit: 5

  alpaca:
    enabled: true
    # Trading endpoints:
    #   Live:  https://api.alpaca.markets
    #   Paper: https://paper-api.alpaca.markets
    # Market data endpoint (bars/quotes): https://data.alpaca.markets
    # Note: Switching paper -> live does NOT change market data access.
    #       Data availability is controlled by market data subscriptions.
    symbols: ["IBIT", "BITO", "DIA", "GLD", "IWM", "QQQ", "SMH", "SPY", "TLT", "XLE", "XLF", "XLK", "NVDA"]
    poll_interval_seconds: 60
    bar_timeframe: "1Min"
    options:
      enabled: false
      # Underlyings for options chain snapshot polling (Alpaca). IBIT + liquid ETF universe (no BITO).
      symbols: ["IBIT", "DIA", "GLD", "IWM", "QQQ", "SMH", "SPY", "TLT", "XLE", "XLF", "XLK"]
      poll_interval_seconds: 60  # 1 minute between chain polls (default)
      min_dte: 7
      max_dte: 21

  yahoo:
    enabled: true
    symbols: ["IBIT", "BITO", "DIA", "GLD", "IWM", "QQQ", "SMH", "SPY", "TLT", "XLE", "XLF", "XLK", "NVDA"]

# -----------------------------------------------------------------------------
# Tastytrade Configuration
# -----------------------------------------------------------------------------
tastytrade:
  environment: "live"   # live | sandbox
  timeout_seconds: 20
  rate_limit_rps: 10
  # IV/Greeks and options streaming: IBIT + liquid ETF universe (BITO dropped)
  underlyings: ["IBIT", "DIA", "GLD", "IWM", "QQQ", "SMH", "SPY", "TLT", "XLE", "XLF", "XLK"]
  snapshot_sampling:
    enabled: true
    retention_days: 14
  retries:
    max_attempts: 3
    backoff_seconds: 1.0
    backoff_multiplier: 2.0


# -----------------------------------------------------------------------------
# Public.com Options Greeks (REST snapshots)
# -----------------------------------------------------------------------------
public:
  base_url: "https://api.public.com"
  timeout_seconds: 20
  rate_limit_rps: 10
  account_id: "5OG33612"   # optional; if empty, connector tries /userapigateway/accounts

public_options:
  enabled: true
  # Underlyings for options chain snapshot polling (Public greeks + structure source).
  symbols: ["IBIT", "DIA", "GLD", "IWM", "QQQ", "SMH", "SPY", "TLT", "XLE", "XLF", "XLK"]
  poll_interval_seconds: 60
  min_dte: 7
  max_dte: 21

# -----------------------------------------------------------------------------
# Alert Configuration
# -----------------------------------------------------------------------------
alerts:
  telegram:
    enabled: true
    tier_1_immediate: true   # IBIT/BITO put spread signal
    tier_2_fyi: true         # IV spike confirmations
    tier_3_background: false # Minor events, logged only
    daily_summary: true
    daily_summary_time: "20:00"  # 8 PM UTC
    rate_limit_seconds: 10  # Min seconds between same-type alerts

  email:
    enabled: false  # Disabled by default, Telegram recommended

# -----------------------------------------------------------------------------
# Database Configuration
# -----------------------------------------------------------------------------
database:
  path: "data/argus.db"
  backup_enabled: true
  backup_interval_hours: 24
  retention_days: 90
  wal_mode: true
  vacuum_on_startup: false   # manual only; runtime stalls risk

# -----------------------------------------------------------------------------
# Performance Tracking (Observation Mode)
# -----------------------------------------------------------------------------
tracking:
  simulate_trades: true
  track_hypothetical_pnl: true

  # Position sizing (percentage-based for flexibility)
  position_size_percent: 10  # 10% of capital per trade
  capital: 800  # Trading capital in USD
  max_leverage: 3

  # Cost assumptions (conservative)
  slippage_bps: 5
  taker_fee_bps: 5

# -----------------------------------------------------------------------------
# Circuit Breakers (Auto-pause trading in extreme scenarios)
# -----------------------------------------------------------------------------
circuit_breakers:
  enabled: true
  max_daily_loss_percent: 5.0  # Pause if daily loss exceeds 5%
  max_consecutive_losses: 5    # Pause after 5 consecutive losses
  cooldown_hours: 24           # Resume trading after cooldown
  alert_on_trigger: true       # Send Telegram alert when triggered

# -----------------------------------------------------------------------------
# Data Retention
# -----------------------------------------------------------------------------
data_retention:
  price_snapshots_days: 60
  detections_days: 180
  logs_days: 60
  raw_ticks_crypto_days: 7     # crypto raw ticks kept 7 days
  raw_ticks_equity_days: 3     # equity ticks kept 3 days
  aggregated_bars_days: 180    # 1m bars kept 6 months
  option_chain_snapshots_days: 30  # Alpaca option_chain_snapshots (used by replay packs). Pruned hourly by orchestrator; or run: python scripts/prune_option_chain_snapshots.py --days 30

# -----------------------------------------------------------------------------
# Health Monitoring
# -----------------------------------------------------------------------------
monitoring:
  health_check_interval: 60  # seconds
  heartbeat_interval: 60     # 60s summary heartbeat log line
  restart_on_failure: true
  max_restarts_per_hour: 10

# -----------------------------------------------------------------------------
# Research Mode (Strategy Discovery)
# -----------------------------------------------------------------------------
research:
  enabled: true
  evaluation_interval_seconds: 60  # Run farm evaluations frequently
  alerts_enabled: false  # Disable live trade alerts during research
  daily_review_enabled: true  # Allow daily review notifications in research
  auto_promote_enabled: true
  promote_after_days: 60
  promotion_window_days: 60
  promotion_min_trades: 30
  promotion_min_total_pnl: 250.0
  promotion_min_avg_pnl: 5.0
  promotion_min_win_rate: 55.0
  promotion_top_n: 5
  live_mode_after_promotion: true

# -----------------------------------------------------------------------------
# Trader Farm Guardrails
# -----------------------------------------------------------------------------
farm:
  max_traders: 2000000               # Hard cap, prevents runaway spawns
  max_open_positions_total: 500000   # Safety valve on total open positions
  max_trades_per_minute: 10000       # Rate limit to protect DB
  default_starting_equity: 5000.0    # Per-trader paper balance

# -----------------------------------------------------------------------------
# Market-Hours-Aware Logging
# -----------------------------------------------------------------------------
market_hours:
  mode: "relaxed"                              # strict | relaxed
  off_hours_sample_interval_seconds: 600       # 10 min pings off-hours
  off_hours_disable_options_snapshots: true
  # US equities session (Eastern Time, Mon-Fri)
  equity_open_hour: 9
  equity_open_minute: 30
  equity_close_hour: 16
  equity_close_minute: 0

# -----------------------------------------------------------------------------
# Local Web Dashboard
# -----------------------------------------------------------------------------
dashboard:
  enabled: true
  host: "127.0.0.1"
  port: 8777

# -----------------------------------------------------------------------------
# Polymarket Integration (Stream 3)
# -----------------------------------------------------------------------------
polymarket:
  enabled: false                          # Set true to activate
  gamma_poll_interval: 60                 # seconds between Gamma discovery polls
  clob_poll_interval: 30                  # seconds between CLOB order-book polls
  watchlist_sync_interval: 300            # seconds between watchlist syncs
  max_watchlist: 50                       # max tokens to track
  min_volume: 10000                       # minimum USD volume to qualify
  keywords: []                            # keyword filter (empty = no filter)

# -----------------------------------------------------------------------------
# Outcome Engine (Phase 4A.1 — bar-level forward returns)
# -----------------------------------------------------------------------------
outcomes:
  enabled: true
  outcome_version: "BAR_OUTCOMES_V1"
  bar_durations_seconds: [60, 300, 900, 3600, 14400, 86400]
  horizons_seconds_by_bar:
    60:    [300, 900, 3600, 14400, 86400]
    300:   [900, 3600, 14400, 86400]
    900:   [3600, 14400, 86400]
    3600:  [14400, 86400]
    14400: [86400]
    86400: [604800]
  gap_tolerance_bars: 1
  lookback_bars_per_symbol: 5000
  quantize_decimals: 10

# -----------------------------------------------------------------------------
# Soak Test Hardening
# -----------------------------------------------------------------------------
soak:
  guard_interval_s: 30                    # How often guards evaluate (seconds)

  guards:
    # EventBus quote drops (should never happen)
    quote_drops_alert_window_s: 300
    quote_drops_alert_threshold: 1

    # Rejected quotes (missing/invalid source_ts)
    rejected_quotes_per_min_threshold: 5

    # Heartbeat staleness
    heartbeat_missing_intervals: 2
    heartbeat_interval_s: 60

    # Persistence write-queue depth
    persist_queue_depth_warn: 5000
    persist_queue_depth_alert: 8000
    persist_queue_sustained_s: 30

    # Persist lag
    persist_lag_p95_warn_ms: 5000
    persist_lag_p95_alert_ms: 15000
    persist_lag_sustained_s: 60
    persist_lag:
      use_crypto_only: true
      deribit_enabled: false
      equities_enabled: false

    # Bar flush failures
    bar_flush_failure_threshold: 1

    # Log flood
    log_error_flood_threshold_per_min: 50
    log_error_flood_window_min: 5

    # Bar liveness (monitored symbols)
    bar_liveness_symbols:
      - "BTC/USDT:USDT"
    bar_liveness_timeout_s: 180

    # Disk fatigue
    disk_free_warn_gb: 5.0
    disk_free_alert_gb: 2.0
    wal_size_warn_mb: 1024
    wal_size_alert_mb: 2048

    # Alert rate limiting
    alert_cooldown_s: 300

  # Tape recorder (determinism artifact capture)
  tape:
    enabled: true                        # Set true to activate
    symbols: []  # Empty = capture all symbols
    maxlen: 100000                        # Max events in rolling buffer
